# ูุธุงู ุงูุชุชุจุน ุงููุญูู (Offline-First) ูุน Geofence

## ูุธุฑุฉ ุนุงูุฉ
ุชู ุชุทููุฑ ูุธุงู ูุชูุฏู ููุนูู ูู ูุถุน Offline-First ูุน ุชุชุจุน ูููุน ูุญูู ูู 5 ุฏูุงุฆู.

---

## ุงูููููุงุช ุงูุฑุฆูุณูุฉ

### 1. **OfflineDataService** ๐ฅ
ุฎุฏูุฉ ุชุฎุฒูู ูุฅุฏุงุฑุฉ ุงูุจูุงูุงุช ุงููุญููุฉ

#### ุงููููุฒุงุช:
- ุชุญููู ุจูุงูุงุช ุงููุฑุน ูู Supabase (Location, BSSID, Geofence Radius)
- ุญูุธ ุงูุจูุงูุงุช ูุญูููุง ุจุงุณุชุฎุฏุงู Hive
- ุชุฎุฒูู ุชุณุฌููุงุช ุงูุญุถูุฑ/ุงูุงูุตุฑุงู ูุญูููุง
- ุชุฎุฒูู ุงููุจุถุงุช (Pulses) ูู 5 ุฏูุงุฆู
- ูุฒุงููุฉ ุงูุจูุงูุงุช ูุน ุงูุณูุฑูุฑ ูุงุญููุง

#### ุงูุฏูุงู ุงูุฑุฆูุณูุฉ:
```dart
// ุชุญููู ุจูุงูุงุช ุงููุฑุน
await downloadBranchData(employeeBranch)

// ุญูุธ ุชุณุฌูู ุฏุฎูู ูุญูู
await saveLocalCheckIn(employeeId, timestamp, lat, lng, bssid)

// ุญูุธ ุชุณุฌูู ุฎุฑูุฌ ูุญูู
await saveLocalCheckOut(employeeId, timestamp, lat, lng, bssid)

// ุญูุธ ูุจุถุฉ ูุญููุฉ
await saveLocalPulse(employeeId, timestamp, lat, lng, insideGeofence, distance)

// ูุฒุงููุฉ ุงูุจูุงูุงุช
await syncToSupabase()
```

---

### 2. **LocalGeofenceService** ๐ฏ
ุฎุฏูุฉ ุงูุชุญูู ูู ุงููููุน ุงูุฌุบุฑุงูู ูุญูููุง

#### ุงููููุฒุงุช:
- ุญุณุงุจ ุงููุณุงูุฉ ุจูู ููุทุชูู (Haversine Formula)
- ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ุฏุงุฎู ุฏุงุฆุฑุฉ Geofence
- ุงูุญุตูู ุนูู ุงููููุน ุงูุญุงูู

#### ุงูุฏูุงู ุงูุฑุฆูุณูุฉ:
```dart
// ุงูุชุญูู ูู ุงููุฌูุฏ ุฏุงุฎู Geofence
bool isInside = isInsideGeofence(
  userLat, userLng, 
  centerLat, centerLng, 
  radiusMeters
);

// ุญุณุงุจ ุงููุณุงูุฉ
double distance = calculateDistance(lat1, lng1, lat2, lng2);

// ุงูุญุตูู ุนูู ุงููููุน
Position? position = await getCurrentLocation();

// ุงูุชุญูู ุงูุดุงูู
Map<String, dynamic>? result = await validateGeofence(
  centerLat, centerLng, radiusMeters
);
```

---

### 3. **PulseTrackingService** ๐
ุฎุฏูุฉ ุงููุจุถุงุช ุงูุชููุงุฆูุฉ ูู 5 ุฏูุงุฆู

#### ุงููููุฒุงุช:
- ุฅุฑุณุงู ูุจุถุฉ ูู 5 ุฏูุงุฆู ุชููุงุฆููุง
- ุงูุชุญูู ูู ุงููููุน ูุญูููุง
- ุญุณุงุจ ุงูููุช ุงูููุถู ุฏุงุฎู Geofence
- ุชุฎุฒูู ุงููุจุถุงุช ูุญูููุง

#### ุงูุงุณุชุฎุฏุงู:
```dart
final pulseService = PulseTrackingService();

// ุจุฏุก ุงูุชุชุจุน
await pulseService.startTracking(employeeId);

// ุฅููุงู ุงูุชุชุจุน
pulseService.stopTracking();

// ุฅุฑุณุงู ูุจุถุฉ ูุฏููุฉ (ููุงุฎุชุจุงุฑ)
await pulseService.sendManualPulse(employeeId);

// ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช
Map<String, dynamic> stats = await pulseService.getTrackingStats(employeeId);
```

---

## ุณูุฑ ุงูุนูู (Workflow)

### 1. ุนูุฏ ูุชุญ ุงูุชุทุจูู ูุฃูู ูุฑุฉ:
```
1. ุงููุณุชุฎุฏู ููุชุญ ุงูุชุทุจูู
2. ูุธูุฑ ุฒุฑ Download (โฌ๏ธ) ูู AppBar
3. ุนูุฏ ุงูุถุบุท:
   - ุชุญููู ุจูุงูุงุช ุงููุฑุน ูู Supabase
   - ุญูุธูุง ูุญูููุง ูู Hive
   - ุจุฏุก ูุธุงู ุงููุจุถุงุช (ูู 5 ุฏูุงุฆู)
4. ุงูุฒุฑ ูุชุญูู ุฅูู Sync (๐)
```

### 2. ุงูุชุณุฌูู ุงููุญูู (Offline):
```
1. Check-In/Check-Out โ ูุชู ูุญูููุง
2. ุงููุจุถุงุช ูู 5 ุฏูุงุฆู โ ุชุชุญูู ูู:
   โ ูู ุงููููุน ุฏุงุฎู Geofenceุ
   โ ุญุณุงุจ ุงููุณุงูุฉ ูู ุงููุฑูุฒ
   โ ุชุฎุฒูู ุงููุชูุฌุฉ ูุญูููุง
3. ุญุณุงุจ ุณุงุนุงุช ุงูุนูู:
   - ูู ูุจุถุฉ ุฏุงุฎู Geofence = 5 ุฏูุงุฆู ุนูู
   - ูุฌููุน ุงููุจุถุงุช = ุฅุฌูุงูู ุงูุณุงุนุงุช
```

### 3. ุงููุฒุงููุฉ ูุน ุงูุณูุฑูุฑ:
```
1. ุงููุณุชุฎุฏู ูุถุบุท Sync (๐)
2. ุฑูุน ุงูุจูุงูุงุช ุงููุญููุฉ:
   - ุณุฌูุงุช ุงูุญุถูุฑ/ุงูุงูุตุฑุงู
   - ุงููุจุถุงุช ุงููุณุฌูุฉ
3. ุชุนููู ุงูุจูุงูุงุช ูู "ูุชุฒุงููุฉ"
4. ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ
```

---

## ุฎูุงุฑุฒููุฉ Geofence

### ุงูุฏุงุฆุฑุฉ ุงููุณููุญุฉ:
```
Center Point: (Latitude, Longitude) ูู ุจูุงูุงุช ุงููุฑุน
Radius: geofence_radius ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (default: 100m)

ูู 5 ุฏูุงุฆู:
1. ุงูุญุตูู ุนูู ูููุน ุงููุณุชุฎุฏู ุงูุญุงูู
2. ุญุณุงุจ ุงููุณุงูุฉ ูู ุงููุฑูุฒ (Haversine)
3. if (distance <= radius):
     โ ุฏุงุฎู ุงูุฏุงุฆุฑุฉ โ ุงุญุชุณุงุจ 5 ุฏูุงุฆู ุนูู
   else:
     โ ุฎุงุฑุฌ ุงูุฏุงุฆุฑุฉ โ ุนุฏู ุงุญุชุณุงุจ ุงูููุช
4. ุญูุธ ุงููุชูุฌุฉ ูุญูููุง
```

---

## ุงูุจูุงูุงุช ุงููุฎุฒูุฉ ูุญูููุง

### 1. branch_data (Hive Box):
```json
{
  "id": "uuid",
  "name": "ุงุณู ุงููุฑุน",
  "latitude": 30.0444,
  "longitude": 31.2357,
  "bssid": "aa:bb:cc:dd:ee:ff",
  "geofence_radius": 100.0,
  "downloaded_at": "2025-11-10T..."
}
```

### 2. local_attendance (Hive Box):
```json
{
  "employee_id": "EMP001",
  "type": "check_in",
  "timestamp": "2025-11-10T09:00:00Z",
  "latitude": 30.0444,
  "longitude": 31.2357,
  "bssid": "aa:bb:cc:dd:ee:ff",
  "synced": false
}
```

### 3. local_pulses (Hive Box):
```json
{
  "employee_id": "EMP001",
  "timestamp": "2025-11-10T09:05:00Z",
  "latitude": 30.0444,
  "longitude": 31.2357,
  "inside_geofence": true,
  "distance_from_center": 45.5,
  "synced": false
}
```

---

## ุญุณุงุจ ุณุงุนุงุช ุงูุนูู

### ุงูุทุฑููุฉ:
```dart
// ุงุญุตู ุนูู ูู ุงููุจุถุงุช ููููู
List<Pulse> pulses = await getPulsesForDate(employeeId, date);

// ุงุญุณุจ ุงููุจุถุงุช ุฏุงุฎู Geofence
int insideCount = pulses.where((p) => p.insideGeofence).length;

// ูู ูุจุถุฉ = 5 ุฏูุงุฆู
double totalMinutes = insideCount * 5.0;
double totalHours = totalMinutes / 60.0;
```

### ูุซุงู:
```
ูู 9:00 ุตุจุงุญูุง ุฅูู 5:00 ูุณุงุกู (8 ุณุงุนุงุช):
- ุนุฏุฏ ุงููุจุถุงุช ุงููุชููุนุฉ: 8 ร 60 / 5 = 96 ูุจุถุฉ
- ุงููุจุถุงุช ุฏุงุฎู Geofence: 90 ูุจุถุฉ
- ุณุงุนุงุช ุงูุนูู: 90 ร 5 / 60 = 7.5 ุณุงุนุฉ
```

---

## ูุงุฌูุฉ ุงููุณุชุฎุฏู

### AppBar ุงูุฌุฏูุฏ:
```dart
AppBar(
  title: Text('ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ'),
  actions: [
    // ุญุงูุฉ ุงูุชุญููู
    if (_isSyncing)
      CircularProgressIndicator(),
    
    // ุฒุฑ ุงูุชุญููู (ุฃูู ูุฑุฉ)
    else if (!_isDataDownloaded)
      IconButton(
        icon: Icon(Icons.download),
        onPressed: _downloadBranchData,
      ),
    
    // ุฒุฑ ุงููุฒุงููุฉ (ุจุนุฏ ุงูุชุญููู)
    else
      IconButton(
        icon: Icon(Icons.sync),
        onPressed: _syncToServer,
      ),
  ],
)
```

---

## ุงููููุฒุงุช

### โ ุงูุนูู ุจุฏูู ุฅูุชุฑูุช
- ุชุณุฌูู ุงูุญุถูุฑ/ุงูุงูุตุฑุงู ูุญูููุง
- ุชุชุจุน ุงููููุน ูุญูููุง
- ุญุณุงุจ ุงูุณุงุนุงุช ูุญูููุง

### โ ุฏูุฉ ุงูุชุชุจุน
- ูุจุถุงุช ูู 5 ุฏูุงุฆู
- ุงูุชุญูู ูู Geofence ูุญูููุง
- ุญุณุงุจ ุงููุณุงูุฉ ุจุฏูุฉ (Haversine Formula)

### โ ููุงุกุฉ ุงูุจุทุงุฑูุฉ
- ูุจุถุงุช ูู 5 ุฏูุงุฆู ููุท (ููุณ ูุณุชูุฑ)
- ุงุณุชุฎุฏุงู GPS ุนูุฏ ุงูุญุงุฌุฉ ููุท
- ุชุฎุฒูู ูุญูู ุฎููู

### โ ุงููุฒุงููุฉ ุงูุฐููุฉ
- ุฑูุน ุงูุจูุงูุงุช ุนูุฏ ุงูุถุบุท ุนูู Sync
- ุชุนููู ุงูุจูุงูุงุช ุงููุชุฒุงููุฉ
- ุนุฏู ุชูุฑุงุฑ ุงูุฑูุน

---

## ุงูุงุฎุชุจุงุฑ

### 1. ุงุฎุชุจุงุฑ ุงูุชุญููู:
```
1. ุงูุชุญ ุงูุชุทุจูู
2. ุงุถุบุท ุฒุฑ Download
3. ุชุฃูุฏ ูู ุธููุฑ ุฑุณุงูุฉ ูุฌุงุญ
4. ุชุฃูุฏ ูู ุชุญูู ุงูุฒุฑ ุฅูู Sync
```

### 2. ุงุฎุชุจุงุฑ ุงููุจุถุงุช:
```
1. ุจุนุฏ ุงูุชุญูููุ ุงูุชุธุฑ 5 ุฏูุงุฆู
2. ุชุญูู ูู Logs:
   โ Pulse #1: INSIDE geofence (45.5m)
3. ูุฑุฑ ูู 5 ุฏูุงุฆู
```

### 3. ุงุฎุชุจุงุฑ ุงููุฒุงููุฉ:
```
1. ุณุฌู ุญุถูุฑ/ุฎุฑูุฌ
2. ุงูุชุธุฑ ุจุถุน ูุจุถุงุช
3. ุงุถุบุท Sync
4. ุชุฃูุฏ ูู ุฑูุน ุงูุจูุงูุงุช ููุณูุฑูุฑ
```

---

## ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุทููุจุฉ

### Supabase Tables:

#### location_pulses (ุฌุฏูุฏ):
```sql
CREATE TABLE location_pulses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_id TEXT NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL,
  latitude DOUBLE PRECISION,
  longitude DOUBLE PRECISION,
  inside_geofence BOOLEAN DEFAULT FALSE,
  distance_from_center DOUBLE PRECISION,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_pulses_employee ON location_pulses(employee_id);
CREATE INDEX idx_pulses_timestamp ON location_pulses(timestamp);
```

---

## ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. โ ุฅูุดุงุก ุงูุฎุฏูุงุช ุงูุซูุงุซุฉ
2. โ ุฅุถุงูุฉ ุฒุฑ Download/Sync ูู AppBar
3. โณ ุฅูุดุงุก ุฌุฏูู location_pulses ูู Supabase
4. โณ ุงุฎุชุจุงุฑ ุงููุธุงู ุจุงููุงูู
5. โณ ุฅุถุงูุฉ ุฅุดุนุงุฑุงุช ูููุจุถุงุช (ุงุฎุชูุงุฑู)

---

## ููุงุญุธุงุช ูููุฉ

โ๏ธ **ุงูุฃุฐููุงุช ุงููุทููุจุฉ:**
- Location Permission (Always)
- Background Location (ูููุจุถุงุช)

โ๏ธ **ุงูุจุทุงุฑูุฉ:**
- ูุจุถุงุช ูู 5 ุฏูุงุฆู ุชุณุชููู ุจุทุงุฑูุฉ ูุนุชุฏูุฉ
- ูููู ุฒูุงุฏุฉ ุงููุชุฑุฉ ุฅูู 10 ุฏูุงุฆู ูุชูููุฑ ุงูุจุทุงุฑูุฉ

โ๏ธ **ุฏูุฉ ุงููููุน:**
- ุงุณุชุฎุฏุงู `LocationAccuracy.high` ููุฏูุฉ
- ูููู ุชูููููุง ุฅูู `medium` ูุชูููุฑ ุงูุจุทุงุฑูุฉ

---

**ุชู ุงูุชุทููุฑ ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** ููููุจุฑ 2025  
**ุงููุณุฎุฉ:** 1.0
