المواصفات الفنية لنظام النبضات (Pulse System Specification)
1. الهدف الأساسي والاستراتيجي (Objective)

الهدف هو إنشاء نظام آلي غير قابل للتلاعب لتسجيل التواجد الفعلي للموظف داخل نطاق العمل. النظام لا يعتمد على "الثقة" في البيانات المرسلة من الموبايل، بل يقوم بالتحقق من كل معلومة بشكل مستقل على الخادم، مما يضمن دقة تصل إلى 100% في حساب ساعات العمل الفعلية.

2. منطق التطبيق (Client-Side Logic - Flutter)

وظيفة تطبيق الموبايل هي "جامع بيانات موثوق" وليس صانع قرار.

آلية التشغيل:

عندما يضغط الموظف على "تسجيل حضور" (Check-in)، تبدأ خدمة خلفية (Background Service) بالعمل فورًا.

هذه الخدمة تظل نشطة حتى لو تم إغلاق التطبيق أو قفل شاشة الهاتف.

تتوقف الخدمة فقط عند ضغط الموظف على "تسجيل انصراف" (Check-out).

تردد النبضات (Pulse Frequency):

تقوم الخدمة الخلفية بإرسال "نبضة" كل 15 ثانية. هذا التردد قابل للتعديل لاحقًا لتحقيق التوازن بين الدقة واستهلاك البطارية.

حمولة النبضة (Pulse Payload):

كل نبضة يتم إرسالها إلى الخادم تحتوي على معلومتين فقط:

shift_id: معرّف الوردية الحالية التي تم إنشاؤها عند تسجيل الحضور.

location: إحداثيات الموقع الجغرافي (خط الطول والعرض) التي تم التقاطها في تلك اللحظة بالضبط.

ملاحظة هامة: التطبيق لا يرسل أي معلومة مثل is_within_geofence. هذا القرار يتم اتخاذه على الخادم فقط.

التعامل مع انقطاع الإنترنت (Offline Handling):

قبل إرسال كل نبضة، يتحقق التطبيق من وجود اتصال بالإنترنت.

في حالة عدم وجود اتصال: يتم تخزين النبضة محليًا في قاعدة بيانات على الهاتف (مثل Hive) مع الاحتفاظ بترتيبها الزمني.

عند عودة الاتصال: يقوم التطبيق بإرسال كل النبضات المخزنة دفعة واحدة إلى الخادم لضمان عدم فقدان أي بيانات.

3. منطق الخادم (Server-Side Logic - Supabase)

هذا هو "العقل المدبر" للعملية بالكامل وهو مصدر الحقيقة الوحيد.

تفعيل PostGIS:

أول خطوة هي تفعيل امتداد postgis في قاعدة بيانات Supabase. هذا الامتداد ضروري للتعامل مع البيانات الجغرافية بكفاءة ودقة.

آلية التحقق الآلي (Automated Geofence Validation):

يتم إنشاء دالة PostgreSQL اسمها validate_pulse_location.

منطق الدالة:

تستقبل الدالة إحداثيات النبضة الجديدة.

يتم تعريف إحداثيات المطعم كنقطة جغرافية ثابتة داخل الدالة (مثال: ST_SetSRID(ST_MakePoint(31.2652, 29.9863), 4326)).

يتم تعريف "نطاق العمل" كدائرة حول هذه النقطة بنصف قطر محدد (مثال: 100 متر).

تستخدم الدالة ST_DWithin للتحقق مما إذا كانت مسافة إحداثيات النبضة تقع داخل نطاق الـ 100 متر.

ترجع الدالة بنتيجة true أو false.

المشغل (Trigger) الإجباري:

يتم إنشاء مشغل (Trigger) في قاعدة البيانات يُطلق عليه trigger_before_pulse_insert.

هذا المشغل يعمل قبل حفظ أي نبضة جديدة في جدول pulses.

وظيفته: يقوم باستدعاء دالة validate_pulse_location، ويأخذ النتيجة (true أو false) ويقوم بتعيينها إجباريًا في حقل is_within_geofence للنبضة الجديدة.

4. بنية البيانات والأمان (Data Structure & Security)

جدول pulses:

يحتوي على حقل location من نوع geography(Point, 4326).

يحتوي على حقل is_within_geofence من نوع boolean. هذا الحقل لا يمكن للتطبيق الكتابة فيه أبدًا. يتم التحكم فيه بالكامل بواسطة المشغل (Trigger) في قاعدة البيانات.

يحتوي على حقل created_at الذي يأخذ قيمته من الخادم (now()) لضمان دقة التوقيت ومنع التلاعب.

الخلاصة: