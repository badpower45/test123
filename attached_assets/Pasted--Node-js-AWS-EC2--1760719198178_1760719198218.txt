ي
🎯 الهدف:
نظام حضور وانصراف للموظفين مع لوحة تحكم للمدير، متصل بسيرفر Node.js على AWS EC2 وقاعدة بيانات PostgreSQL (Neon).

🏗️ البنية الحالية:
1. Backend (Node.js + TypeScript):
المسار: index.ts

السيرفر: AWS EC2 على http://16.171.208.249:5000

قاعدة البيانات: PostgreSQL (Neon) - الـ connection string في .env

الـ Endpoints الموجودة:

/api/auth/login - تسجيل دخول الموظف (employee_id + pin)
/api/attendance/check-in - تسجيل حضور
/api/attendance/check-out - تسجيل انصراف
/api/leave/request - طلب إجازة
/api/advances/request - طلب سلفة
/api/pulses - إرسال نبضة (heartbeat)
/api/branch/:branch/requests - جلب طلبات الفرع (للمدير)
/api/branch/:branch/attendance-report - تقرير الحضور (للمدير)
/api/branch/request/:type/:id/:action - موافقة/رفض الطلبات
المشكلة الحالية: الـ manager endpoints موجودة في الكود لكن محتاجة testing وربط كامل بالـ Flutter app.

2. Frontend (Flutter):
المسار: lib

الشاشات الرئيسية:

screens/login_screen.dart - تسجيل الدخول
screens/home_screen.dart - الصفحة الرئيسية للموظف
screens/branch_manager_screen.dart - لوحة تحكم المدير (محتاجة تكملة)
screens/profile_screen.dart - الملف الشخصي
الـ Services:

services/auth_api_service.dart - تسجيل الدخول
services/attendance_api_service.dart - الحضور والانصراف
branch_manager_api_service.dart - طلبات المدير (موجود لكن محتاج ربط)
الـ API Endpoints:

constants/api_endpoints.dart - كل الـ URLs موجهة لـ EC2 server
🔧 المطلوب إكماله:
أولاً: صفحة المدير (Branch Manager):
ربط كامل بالـ API:

جلب الطلبات (إجازة، سلفة، حضور/انصراف، غياب) من /api/branch/:branch/requests
عرض تقرير الحضور اليومي من /api/branch/:branch/attendance-report
الموافقة/الرفض على الطلبات عبر /api/branch/request/:type/:id/:action
الواجهة:

عرض الطلبات في tabs (إجازة، سلفة، حضور، غياب)
كل طلب له زر ✓ (موافقة) و ✗ (رفض)
تقرير الحضور يعرض الموظفين الحاليين في الفرع
ثانياً: تحسينات ضرورية:
إصلاح الـ encoding للعربي:

حالياً الأسماء العربية بترجع ??? من السيرفر
الحل المؤقت: استخدام أسماء إنجليزية
الحل الدائم: ضبط الـ charset في PostgreSQL أو استخدام SET client_encoding TO 'UTF8'
تسجيل الدخول:

حالياً بيشتغل بـ employee_id + pin
لو المستخدم role = 'manager' يروح على BranchManagerScreen
لو role = 'staff' يروح على HomeScreen
بيانات الاختبار:

موظف: EMP001 / 1234 (فرع: "فرع المعادي" لكن بيظهر ???)
مدير: MGR002 / 8888 (نفس المشكلة)
حل مؤقت: أضف موظفين بأسماء إنجليزية:
📂 الملفات المهمة:
Backend:
index.ts - كل الـ endpoints
db.ts - الاتصال بقاعدة البيانات (استخدم relative imports فقط: '../shared/schema.js')
schema.ts - تعريف الجداول (Drizzle ORM)
.env - فيه DATABASE_URL للـ Neon PostgreSQL
Frontend:
branch_manager_api_service.dart - هنا المشكلة (محتاج ربط كامل)
branch_manager_screen.dart - محتاج تكملة الواجهة
api_endpoints.dart - كل الـ URLs
⚠️ مشاكل معروفة:
Path Aliases:

لا تستخدم @shared/... في الـ imports على السيرفر
استخدم فقط: '../shared/schema.js' (relative path)
Arabic Encoding:

الأسماء العربية بترجع ??? من PostgreSQL
حل مؤقت: استخدم أسماء إنجليزية
حل دائم: ضبط الـ client_encoding
PM2 على EC2:

السيرفر بيشتغل بـ: pm2 start dist/index.js --name oldies-api
لو عايز تعمل restart: pm2 restart oldies-api
لو عايز تشوف logs: pm2 logs oldies-api
🚀 الخطوات التالية:
أكمل صفحة المدير:

افتح branch_manager_screen.dart
اعمل setState لما تجيب الداتا من الـ API
اعرض الطلبات في ListView مع أزرار الموافقة/الرفض
اختبر الـ endpoints:

استخدم Postman أو curl للتأكد:
Deploy:

لو عدلت في السيرفر، اعمل:
📞 للتواصل:
السيرفر: ssh -i "D:\mytest123.pem" ubuntu@16.171.208.249
قاعدة البيانات: Neon PostgreSQL (الـ connection string في .env)
ملحوظة: الكود شغال 80%، المتبقي هو ربط صفحة المدير بالـ API وإصلاح الـ encoding للعربي. باقي الـ features (حضور، انصراف، طلبات إجازة، سلف) كلها شغالة 100%.

